<?php
 namespace OAW\Backend\Services; use OAW\Backend\Controllers\FeedController; use OAW\Backend\Controllers\NewsController; use SimplePie\SimplePie; class FeedService { private $conn; private $feedController; private $newsController; public function __construct($conn) { $this->conn = $conn; $this->feedController = new FeedController($conn); $this->newsController = new NewsController($conn); } public function fetchAndSaveNews() { $feeds = $this->feedController->getFeeds(); foreach ($feeds as $feed) { $feed_id = $feed['id']; $url = $feed['url']; $pie = new SimplePie(); $pie->enable_cache(false); $pie->set_feed_url($url); $pie->init(); if ($pie->error()) { error_log("Error al obtener el feed: " . $pie->error()); continue; } foreach ($pie->get_items() as $item) { $link = $item->get_permalink(); if ($this->newsController->linkExists($link)) { error_log("El enlace ya existe: $link"); continue; } $title = $item->get_title(); $description = $item->get_description(); $sanitized_description = $item->sanitize($description, SimplePie::CONSTRUCT_XHTML); $pub_date = $item->get_date('Y-m-d H:i:s'); $categories = []; if ($item_categories = $item->get_categories()) { foreach ($item_categories as $category) { $label = $category->get_label(); if (!empty($label)) { $categories[] = $label; } } } $categories_json = !empty($categories) ? json_encode($categories, JSON_UNESCAPED_UNICODE) : null; if (!$this->newsController->addNews($feed_id, $title, $sanitized_description, $link, $pub_date, $categories_json)) { error_log("Error al insertar la noticia: $link"); } } $pie->__destruct(); unset($pie); } return true; } } ?>
