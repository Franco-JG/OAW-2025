<?php
 require_once __DIR__ . '/../vendor/autoload.php'; header("Access-Control-Allow-Origin: *"); header("Content-Type: application/json"); header("Access-Control-Allow-Methods: GET, POST, OPTIONS"); header("Access-Control-Allow-Headers: Content-Type"); if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { http_response_code(200); exit(); } require_once '../config/database.php'; use OAW\Backend\Controllers\FeedController; use OAW\Backend\Controllers\NewsController; use OAW\Backend\Services\FeedService; $feedService = new FeedService($conn); $feedController = new FeedController($conn); $newsController = new NewsController($conn); try { if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['feeds'])) { $result = $feedController->getFeeds(); echo json_encode([ "success" => true, "data" => $result ]); } elseif ($_SERVER['REQUEST_METHOD'] === 'GET' && (isset($_GET['news']) && isset($_GET['q']))) { $result = $newsController->searchNews($_GET['q']); echo json_encode([ "success" => true, "data" => $result ]); } elseif ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['news'])) { $orderBy = isset($_GET['order']) ? $_GET['order'] : "pub_date"; error_log("Ordenando por: $orderBy"); $allowedColumns = ["title", "description", "pub_date", "created_at"]; if (!in_array($orderBy, $allowedColumns)) { echo json_encode([ "success" => false, "data" => "Campo no válido" ]); exit(); } $result = $newsController->getNews($orderBy); echo json_encode([ "success" => true, "data" => $result ]); } else if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_GET['feeds'])) { $rawData = file_get_contents("php://input"); $data = json_decode($rawData, true); if (!isset($data['url'])) { throw new Exception("URL del feed no proporcionada"); } $result = $feedController->addFeed($data); if ($result) { http_response_code(201); echo json_encode([ "success" => true, "data" => "Feed: " . $data['url'] . " agregado correctamente" ]); } else { throw new Exception("Error al agregar el feed"); } } elseif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_GET['news'])) { $result = $feedService->fetchAndSaveNews(); if ($result) { echo json_encode([ "success"=> true, "data"=>"Noticias actualizadas" ]); } } else { throw new Exception("Endpoint no válido"); } } catch (Exception $e) { http_response_code(400); echo json_encode([ "success" => false, "error" => $e->getMessage() ]); } ?>
